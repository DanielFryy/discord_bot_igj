name: Discord notifier

run-name: ${{ github.actor }} triggered ${{ github.workflow }} on ${{ github.repository }} üöÄ

on:
  push:
    branches:
      - main

jobs:
  install:
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Node.js dependencies
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('yarn.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: yarn

      - name: Persist Node modules
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: yarn

  tests:
    needs: install
    runs-on: ubuntu-latest
    steps:
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore Node.js dependencies from cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('yarn.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Run tests
        run: yarn test:all

      - name: Notify Discord on Build Success
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
          -d '{
                "embeds": [
                  {
                    "title": "‚úÖ Tests Succeeded!",
                    "description": "The tests for commit [`${{ github.sha }}`](${{
                      github.server_url
                    }}/${{ github.repository }}/commit/${{ github.sha }}) by **${{
                      github.actor
                    }}** have succeeded.",
                    "color": 3066993,
                    "fields": [
                      {
                        "name": "Branch",
                        "value": "${{ github.ref_name }}",
                        "inline": true
                      },
                      {
                        "name": "Commit",
                        "value": "[`${{ github.sha }}`](${{
                          github.server_url
                        }}/${{ github.repository }}/commit/${{ github.sha }})",
                        "inline": true
                      }
                    ],
                    "footer": {
                      "text": "GitHub Actions",
                      "icon_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                    },
                    "timestamp": "'$(date --utc +%FT%TZ)'"
                  }
                ]
              }' \
          ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Notify Discord on Build Failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
          -d '{
                "embeds": [
                  {
                    "title": "‚ùå Tests Failed!",
                    "description": "The tests for commit [`${{ github.sha }}`](${{
                      github.server_url
                    }}/${{ github.repository }}/commit/${{ github.sha }}) by **${{
                      github.actor
                    }}** have failed. Please check the [logs](${{
                      github.server_url
                    }}/${{ github.repository }}/actions/runs/${{
                      github.run_id
                    }}) for more details.",
                    "color": 15158332,
                    "fields": [
                      {
                        "name": "Branch",
                        "value": "${{ github.ref_name }}",
                        "inline": true
                      },
                      {
                        "name": "Commit",
                        "value": "[`${{ github.sha }}`](${{
                          github.server_url
                        }}/${{ github.repository }}/commit/${{ github.sha }})",
                        "inline": true
                      }
                    ],
                    "footer": {
                      "text": "GitHub Actions",
                      "icon_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                    },
                    "timestamp": "'$(date --utc +%FT%TZ)'"
                  }
                ]
              }' \
          ${{ secrets.DISCORD_WEBHOOK_URL }}

  build:
    needs: install
    runs-on: ubuntu-latest
    steps:
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore Node.js dependencies from cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('yarn.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Build the Discord bot
        run: yarn build

      - name: Notify Discord on Build Success
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
          -d '{
                "embeds": [
                  {
                    "title": "‚úÖ Build Succeeded!",
                    "description": "The build for commit [`${{ github.sha }}`](${{
                      github.server_url
                    }}/${{ github.repository }}/commit/${{ github.sha }}) by **${{
                      github.actor
                    }}** have succeeded.",
                    "color": 3066993,
                    "fields": [
                      {
                        "name": "Branch",
                        "value": "${{ github.ref_name }}",
                        "inline": true
                      },
                      {
                        "name": "Commit",
                        "value": "[`${{ github.sha }}`](${{
                          github.server_url
                        }}/${{ github.repository }}/commit/${{ github.sha }})",
                        "inline": true
                      }
                    ],
                    "footer": {
                      "text": "GitHub Actions",
                      "icon_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                    },
                    "timestamp": "'$(date --utc +%FT%TZ)'"
                  }
                ]
              }' \
          ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Notify Discord on Build Failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
          -d '{
                "embeds": [
                  {
                    "title": "‚ùå BuildFailed!",
                    "description": "The build for commit [`${{ github.sha }}`](${{
                      github.server_url
                    }}/${{ github.repository }}/commit/${{ github.sha }}) by **${{
                      github.actor
                    }}** have failed. Please check the [logs](${{
                      github.server_url
                    }}/${{ github.repository }}/actions/runs/${{
                      github.run_id
                    }}) for more details.",
                    "color": 15158332,
                    "fields": [
                      {
                        "name": "Branch",
                        "value": "${{ github.ref_name }}",
                        "inline": true
                      },
                      {
                        "name": "Commit",
                        "value": "[`${{ github.sha }}`](${{
                          github.server_url
                        }}/${{ github.repository }}/commit/${{ github.sha }})",
                        "inline": true
                      }
                    ],
                    "footer": {
                      "text": "GitHub Actions",
                      "icon_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                    },
                    "timestamp": "'$(date --utc +%FT%TZ)'"
                  }
                ]
              }' \
          ${{ secrets.DISCORD_WEBHOOK_URL }}
